parameters:
  - name: 'WORKING_DIRECTORY'
    type: 'string'
    default: ''
  - name: 'RUN_BEFORE_MANAGEMENT'
    type: 'string'
    default: 'echo "No before script"'
  - name: 'RUN_AFTER_MANAGEMENT'
    type: 'string'
    default: 'echo "No after script"'

steps:
  - task: 'Cache@2'
    inputs:
      # TODO: this key should be better according to sonar version
      key: "$(Agent.JobName)|${{ parameters.WORKING_DIRECTORY }}/yarn.lock"
      path: "$(SONAR_USER_HOME)"
    displayName: 'Cache for SonarQube'
    continueOnError: true

  - task: 'DownloadPipelineArtifact@2'
    inputs:
      artifactName: 'cobertura-coverage'
      targetPath: "${{ parameters.WORKING_DIRECTORY }}/coverage"
    displayName: 'Download Cobertura Coverage File'

  - script: ${{ parameters.RUN_BEFORE_MANAGEMENT }}
    workingDirectory: "${{ parameters.WORKING_DIRECTORY }}"
    displayName: 'Run Before'

  - script: yarn sonar
    workingDirectory: "${{ parameters.WORKING_DIRECTORY }}"
    displayName: 'Run SonarQube'

  - script: ${{ parameters.RUN_AFTER_MANAGEMENT }}
    workingDirectory: "${{ parameters.WORKING_DIRECTORY }}"
    displayName: 'Run After'
