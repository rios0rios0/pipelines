parameters:
  - name: 'DOCKER_FILE'
    type: 'string'
  - name: 'DOCKER_CACHE_DIR'
    type: 'string'
  - name : 'CONTAINER_REGISTRY_SERVER'
    type: 'string'
  - name: 'CONTAINER_REGISTRY_SERVICE_CONNECTION'
    type: 'string'
  - name: 'DOCKER_BUILD_ARGS'
    type: 'string'
    default: ''
  - name: 'WORKING_DIRECTORY'
    type: 'string'
    default: "$(Build.SourcesDirectory)" # or $(System.DefaultWorkingDirectory)
  - name: 'RUN_BEFORE_BUILD'
    type: 'string'
    default: ''
  - name: 'IMAGE_NAME'
    type: 'string'
    default: ''

steps:
  - task: 'Cache@2'
    inputs:
      key: "$(Agent.JobName)|${{ parameters.WORKING_DIRECTORY }}/${{ parameters.DOCKER_FILE }}"
      path: "${{ parameters.DOCKER_CACHE_DIR }}"
    displayName: 'Cache Docker Buildx'
    continueOnError: true

  - task: 'Docker@2'
    displayName: 'Docker Login in dhi.io'
    condition: and(succeeded(), ne(variables['CONTAINER_REGISTRY_DHI_CONNECTION'], ''))
    inputs:
      command: 'login'
      containerRegistry: "$(CONTAINER_REGISTRY_DHI_CONNECTION)"

  - task: 'Docker@2'
    displayName: 'Docker Login'
    condition: ne('${{ parameters.CONTAINER_REGISTRY_SERVICE_CONNECTION }}', '')
    inputs:
      containerRegistry: "${{ parameters.CONTAINER_REGISTRY_SERVICE_CONNECTION }}"
      command: 'login'

  - script: |
        dockerImageName=$(Build.Repository.Name)
        if [ -n "${{ parameters.IMAGE_NAME }}" ]; then
          dockerImageName="${{ parameters.IMAGE_NAME }}"
        fi
        imageName="${{ parameters.CONTAINER_REGISTRY_SERVER }}/$dockerImageName"

        TAGS="$imageName:latest"
        if [[ "$(Build.SourceBranch)" == refs/tags/* ]]; then
          TAGS="$imageName:latest $imageName:$(Build.SourceBranchName)"
          containerImageTagName="$imageName:$(Build.SourceBranchName)"
        else
          containerImageTagName="$TAGS"
        fi

        echo "##vso[task.setvariable variable=IMAGE_NAME]$imageName"
        echo "##vso[task.setvariable variable=TAGS]$TAGS"
    displayName: 'Configure image name and tags'

  - script: |
        export DOCKER_BUILDKIT=1
        docker buildx create --driver docker-container --use
        docker buildx inspect --bootstrap
    displayName: 'Create Buildx Builder'

  - script: |
        PLATFORMS="linux/amd64,linux/arm64"

        ${{ parameters.RUN_BEFORE_BUILD }}

        TAG_ARGS=""
        for tag in $(TAGS); do
          TAG_ARGS="$TAG_ARGS --tag $tag"
        done

        docker buildx build ${{ parameters.DOCKER_BUILD_ARGS }} \
          --platform $PLATFORMS \
          --progress=plain \
          $TAG_ARGS \
          --cache-from=type=local,src=${{ parameters.DOCKER_CACHE_DIR }} \
          --cache-to=type=local,dest=${{ parameters.DOCKER_CACHE_DIR }},mode=max \
          --file ${{ parameters.DOCKER_FILE }} \
          --push .
    displayName: 'Build and push the image'
    workingDirectory: "${{ parameters.WORKING_DIRECTORY }}"
    env:
      BUILDKIT_PROGRESS: plain
      DOCKER_CONFIG: /home/vsts/.docker
    # TODO: retryCountOnTaskFailure is set to 2 because on the first execution,
    # the application sometimes can't find the base image in DHI registry.
    # This appears to be a transient issue that resolves on retry, likely due to
    # registry propagation delay or authentication timing. Retrying allows the
    # build to succeed after the base image becomes available.
    retryCountOnTaskFailure: 2
