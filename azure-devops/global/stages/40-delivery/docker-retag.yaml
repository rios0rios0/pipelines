parameters:
  - name: 'CONTAINER_REGISTRY_SERVER'
    type: 'string'
  - name: 'CONTAINER_REGISTRY_SERVICE_CONNECTION'
    type: 'string'
  - name: 'SOURCE_TAG'
    type: 'string'
    default: 'latest'
  - name: 'TARGET_TAG'
    type: 'string'
    default: '$(Build.SourceBranchName)'

steps:
  - task: 'Docker@2'
    displayName: 'Docker Login'
    inputs:
      containerRegistry: "${{ parameters.CONTAINER_REGISTRY_SERVICE_CONNECTION }}"
      command: 'login'

  - script: |
      set -e
      IMAGE_NAME="${{ parameters.CONTAINER_REGISTRY_SERVER }}/$(Build.Repository.Name)"
      SOURCE_TAG="${{ parameters.SOURCE_TAG }}"
      TARGET_TAG="${{ parameters.TARGET_TAG }}"
      
      echo "Pulling ${IMAGE_NAME}:${SOURCE_TAG}..."
      docker pull "${IMAGE_NAME}:${SOURCE_TAG}"
      
      # Verify the image was pulled successfully
      if ! docker image inspect "${IMAGE_NAME}:${SOURCE_TAG}" > /dev/null 2>&1; then
        echo "Error: Failed to pull ${IMAGE_NAME}:${SOURCE_TAG}"
        echo "Please ensure the source image exists before creating a release tag."
        exit 1
      fi
      
      # Get and display the image digest
      DIGEST=$(docker image inspect "${IMAGE_NAME}:${SOURCE_TAG}" --format='{{index .RepoDigests 0}}' || echo "digest unavailable")
      echo "Source image digest: ${DIGEST}"
      
      echo "Tagging ${IMAGE_NAME}:${SOURCE_TAG} as ${IMAGE_NAME}:${TARGET_TAG}..."
      docker tag "${IMAGE_NAME}:${SOURCE_TAG}" "${IMAGE_NAME}:${TARGET_TAG}"
      
      echo "Pushing ${IMAGE_NAME}:${TARGET_TAG}..."
      docker push "${IMAGE_NAME}:${TARGET_TAG}"
      
      # Verify the pushed image has the same digest
      PUSHED_DIGEST=$(docker image inspect "${IMAGE_NAME}:${TARGET_TAG}" --format='{{index .RepoDigests 0}}' || echo "digest unavailable")
      echo "Pushed image digest: ${PUSHED_DIGEST}"
      
      if [ "$DIGEST" != "$PUSHED_DIGEST" ] && [ "$DIGEST" != "digest unavailable" ]; then
        echo "Warning: Digest mismatch detected"
        echo "  Source: $DIGEST"
        echo "  Pushed: $PUSHED_DIGEST"
      else
        echo "âœ“ Successfully retagged image"
      fi
      
      # Set output variable
      echo "##vso[task.setvariable variable=CONTAINER_IMAGE;isOutput=true]${IMAGE_NAME}:${TARGET_TAG}"
    name: 'retag'
    displayName: 'Retag and Push Docker Image'
