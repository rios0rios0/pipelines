on:
  workflow_call:

jobs:
  go:
    uses: 'rios0rios0/pipelines/.github/workflows/go.yaml@main'

  # fourth stage - build and push :latest on main
  delivery-docker:
    name: 'delivery > docker'
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'rios0rios0/pipelines/github/global/stages/40-delivery/docker@main'
    needs: [ 'go' ]
    if: "!failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'"

  # fourth stage - retag :latest as release tag on tag push
  delivery-docker-retag:
    name: 'delivery > docker retag'
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'rios0rios0/pipelines/github/global/stages/40-delivery/docker-retag@main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_tag: 'latest'
          target_tag: ${{ github.ref_name }}
    if: "!failure() && startsWith(github.ref, 'refs/tags/')"
