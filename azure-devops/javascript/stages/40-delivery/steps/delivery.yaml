parameters:
  - name: 'WORKING_DIRECTORY'
    type: 'string'
    default: ''
  - name: 'RUN_BEFORE_DELIVERY'
    type: 'string'
    default: 'echo "No before script"'
  - name: 'RUN_AFTER_DELIVERY'
    type: 'string'
    default: 'echo "No after script"'
  - name: 'DOCKER_BUILD_ARGS'
    type: 'string'
    default: ''
  - name: RUN_BEFORE_BUILD
    type: 'string'
    default: ''

steps:
  - script: ${{ parameters.RUN_BEFORE_DELIVERY }}
    workingDirectory: "${{ parameters.WORKING_DIRECTORY }}"
    displayName: 'Run Before'

  - script: yarn build
    workingDirectory: "${{ parameters.WORKING_DIRECTORY }}"
    displayName: 'Run Build'

  - script: ${{ parameters.RUN_AFTER_DELIVERY }}
    workingDirectory: "${{ parameters.WORKING_DIRECTORY }}"
    displayName: 'Run After'

  - template: '../../../../global/stages/40-delivery/docker.yaml'
    parameters:
      DOCKER_FILE: '.ci/40-delivery/app.Dockerfile'
      DOCKER_CACHE_DIR: "$(DOCKER_CACHE_DIR)"
      CONTAINER_REGISTRY_SERVER: "$(CONTAINER_REGISTRY_SERVER)"
      CONTAINER_REGISTRY_SERVICE_CONNECTION: "$(CONTAINER_REGISTRY_SERVICE_CONNECTION)"
      DOCKER_BUILD_ARGS: "${{ parameters.DOCKER_BUILD_ARGS }}"
      WORKING_DIRECTORY: "${{ parameters.WORKING_DIRECTORY }}"
      RUN_BEFORE_BUILD: "${{ parameters.RUN_BEFORE_BUILD }}"
